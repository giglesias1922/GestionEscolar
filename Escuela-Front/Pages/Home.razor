@page "/"
@using Escuela_Front.Services
@using Escuela_Front.Models
@inject AsignaturasService AsigSvc
@inject EstudiantesService EstSvc
@inject CursosService CurSvc
@inject IConfiguration Config

<PageTitle>Home</PageTitle>

<MudText Typo="Typo.h4" GutterBottom="true" Class="mb-4">Resumen General</MudText>

<MudGrid>
    <MudItem xs="12" sm="6" md="4">
        <MudCard Elevation="3" Class="stat-card">
            <MudCardContent>
                <div class="stat-content">
                    <div class="stat-icon estudiantes">
                        <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Large" />
                    </div>
                    <div class="stat-info">
                        <MudText Typo="Typo.h6" Class="stat-label">Estudiantes</MudText>
                        <MudText Typo="Typo.h3" Class="stat-value">@estCount</MudText>
                    </div>
                </div>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <MudItem xs="12" sm="6" md="4">
        <MudCard Elevation="3" Class="stat-card">
            <MudCardContent>
                <div class="stat-content">
                    <div class="stat-icon asignaturas">
                        <MudIcon Icon="@Icons.Material.Filled.Book" Size="Size.Large" />
                    </div>
                    <div class="stat-info">
                        <MudText Typo="Typo.h6" Class="stat-label">Asignaturas</MudText>
                        <MudText Typo="Typo.h3" Class="stat-value">@asigCount</MudText>
                    </div>
                </div>
            </MudCardContent>
        </MudCard>
    </MudItem>    
    
    
    <MudItem xs="12" sm="6" md="4">
        <MudCard Elevation="3" Class="stat-card">
            <MudCardContent>
                <div class="stat-content">
                    <div class="stat-icon cursos">
                        <MudIcon Icon="@Icons.Material.Filled.School" Size="Size.Large" />
                    </div>
                    <div class="stat-info">
                        <MudText Typo="Typo.h6" Class="stat-label">Cursos</MudText>
                        <MudText Typo="Typo.h3" Class="stat-value">@cursoCount</MudText>
                    </div>
                </div>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <MudItem xs="12" Class="mt-6">
        <MudText Typo="Typo.h6"  GutterBottom="true" Class="mb-4">Estudiantes y asignaturas por curso</MudText>
    </MudItem>
    
    <MudItem xs="12" Class="d-flex justify-center">
        <MudPaper Class="pa-4" Style="width: 100%; max-width: 1200px;">
            <MudChart ChartType="ChartType.StackedBar" ChartSeries="@chartSeries" XAxisLabels="@xAxisLabels" Width="100%" Height="350px">
                <CustomGraphics>
                    <style>
                        .heavy {
                            font: bold 30px Helvetica;
                        }

                        .Rrrrr {
                            font: italic 40px Helvetica;
                            fill: rgb(62,44,221);
                        }
                    </style>
                </CustomGraphics>
            </MudChart>
        </MudPaper>
    </MudItem>
</MudGrid>

@code{
    int asigCount, estCount, cursoCount;
    List<Curso>? cursos;

    List<ChartSeries> chartSeries = new();
    string[] xAxisLabels = Array.Empty<string>();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var asignaturas = await AsigSvc.GetAllAsync();
            var estudiantes = await EstSvc.GetAllAsync();
            cursos = await CurSvc.GetAllAsync();

            asigCount = asignaturas?.Count ?? 0;
            estCount = estudiantes?.Count ?? 0;
            cursoCount = cursos?.Count ?? 0;

            if (cursos != null && cursos.Count > 0)
            {
                var validCursos = cursos
                    .Where(c => !string.IsNullOrWhiteSpace(c.Nombre))
                    .ToList();

                if (validCursos.Any())
                {
                    xAxisLabels = validCursos
                        .Select(c => c.Nombre)
                        .ToArray();

                    var asignaturasPorCurso = validCursos
                        .Select(c => (double)(c.Asignaturas?.Count ?? 0))
                        .ToArray();

                    var estudiantesPorCurso = validCursos
                        .Select(c => (double)(c.Estudiantes?.Count ?? 0))
                        .ToArray();

                    chartSeries = new List<ChartSeries>()
                    {
                        new ChartSeries
                        {
                            Name = "Asignaturas",
                            Data = asignaturasPorCurso
                        },
                        new ChartSeries
                        {
                            Name = "Estudiantes",
                            Data = estudiantesPorCurso
                        }
                    };
                }
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error loading data: {ex.Message}");
        }
    }
}

